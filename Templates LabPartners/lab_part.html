<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lab Partner Dashboard - RevibeFit</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="/CSS/lab.css" />
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="sidebar-header">
          <h2>Lab Dashboard</h2>
        </div>
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="lab_part.html" class="nav-link active">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
            </svg>
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a href="upload.html" class="nav-link">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
            </svg>Upload Tests </a>
          </li>
          <li class="nav-item">
            <a href="records.html" class="nav-link"> 
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
            </svg>Records </a>
          </li>
          <li class="nav-item">
            <a href="settings2.html" class="nav-link"> 
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zm-7.43 2.52c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/>
            </svg>Settings </a>
          </li>
        </ul>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <div class="dashboard-header">
          <h1>Lab Partner Dashboard</h1>
          <div class="notification-badge">
            <span class="badge" id="pending-count">0</span>
            <span>New Bookings</span>
          </div>
        </div>

        <!-- Booking Notifications Section -->
        <div class="section-container">
          <h2>Recent Test Bookings</h2>
          <div class="bookings-list" id="bookings-list">
            <!-- pending requests will be injected here -->
          </div>
        </div>
      </div>
    </div>

    <script>
      // Load Lab Name into Sidebar
      (async () => {
        try {
          const res = await fetch("http://localhost:3001/me", {
            credentials: "include",
          });
          if (!res.ok) throw new Error(res.status);
          const user = await res.json();
          const labName = user.labProfile?.lab_name || "Lab Dashboard";
          document.querySelector(".sidebar-header h2").textContent = labName;
        } catch (err) {
          console.error("Failed to load lab name:", err);
        }
      })();

      // Fetch & display pending bookings
      async function loadPending() {
        try {
          const res = await fetch("http://localhost:3001/pending", {
            credentials: "include",
          });
          if (!res.ok) throw new Error(res.status);
          const apps = await res.json();
          const list = document.getElementById("bookings-list");
          list.innerHTML = "";
          document.getElementById("pending-count").textContent = apps.length;
          apps.forEach((app) => {
            const date = app.createdAt.split("T")[0];
            const patient = app.applicant.name;
            const contact = app.applicant.phone || app.applicant.email;
            const card = document.createElement("div");
            card.className = "booking-card new";
            card.innerHTML = `
              <div class="booking-info">
                <h3>New Booking Request</h3>
                <p>Patient: ${patient}</p>
                <p>Test: Lab Test Application</p>
                <p>Requested Date: ${date}</p>
                <p>Contact: ${contact}</p>
              </div>
              <div class="booking-actions">
                <button class="confirm-btn btn btn-primary" data-id="${app._id}">Confirm</button>
                <button class="reschedule-btn btn btn-secondary" data-id="${app._id}">Reschedule</button>
              </div>`;
            list.appendChild(card);
          });
        } catch (err) {
          console.error("Failed to load bookings:", err);
        }
      }

      // Approve/Disapprove handler
      document
        .getElementById("bookings-list")
        .addEventListener("click", async (e) => {
          const isConfirm = e.target.matches(".confirm-btn");
          const isReschedule = e.target.matches(".reschedule-btn");
          if (!isConfirm && !isReschedule) return;
          const status = isConfirm ? "approved" : "disapproved";
          const id = e.target.dataset.id;
          try {
            const res = await fetch(`http://localhost:3001/${id}/status`, {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({ status }),
            });
            if (!res.ok) throw new Error(res.status);
            // remove card
            e.target.closest(".booking-card").remove();
            // update badge
            const count =
              parseInt(
                document.getElementById("pending-count").textContent,
                10
              ) - 1;
            document.getElementById("pending-count").textContent = count;
          } catch (err) {
            console.error("Status update failed:", err);
            alert("Action failed. Please try again.");
          }
        });

      // initial load
      loadPending();
    </script>
  </body>
</html>
